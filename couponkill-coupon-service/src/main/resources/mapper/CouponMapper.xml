<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aliyun.seckill.couponkillcouponservice.mapper.CouponMapper">

    <resultMap id="CouponResultMap" type="com.aliyun.seckill.common.pojo.Coupon">
        <id property="id" column="id"/>
        <result property="virtualId" column="virtual_id"/>
        <result property="name" column="name"/>
        <result property="description" column="description"/>
        <result property="type" column="type"/>
        <result property="faceValue" column="face_value"/>
        <result property="minSpend" column="min_spend"/>
        <result property="validDays" column="valid_days"/>
        <result property="perUserLimit" column="per_user_limit"/>
        <result property="totalStock" column="total_stock"/>
        <result property="seckillTotalStock" column="seckill_total_stock"/>
        <result property="remainingStock" column="remaining_stock"/>
        <result property="seckillRemainingStock" column="seckill_remaining_stock"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="version" column="version"/>
    </resultMap>

    <select id="selectAvailableCoupons" resultMap="CouponResultMap">
        SELECT * FROM coupon
        WHERE status = 1
        AND remaining_stock > 0
        ORDER BY create_time DESC
    </select>

    <select id="selectAll" resultMap="CouponResultMap">
        SELECT * FROM coupon
        ORDER BY create_time DESC
    </select>

    <select id="selectById" resultMap="CouponResultMap">
        SELECT * FROM coupon WHERE id = #{id}
    </select>

    <select id="selectByVirtualId" resultMap="CouponResultMap">
        SELECT * FROM coupon WHERE virtual_id = #{virtualId}
    </select>

    <insert id="insertCoupon" parameterType="com.aliyun.seckill.common.pojo.Coupon">
        INSERT INTO coupon (
            id, virtual_id, name, description, type, face_value, min_spend, valid_days,
            per_user_limit, total_stock, seckill_total_stock, remaining_stock,
            seckill_remaining_stock, status, create_time, update_time, version
        ) VALUES (
            #{id}, #{virtualId}, #{name}, #{description}, #{type}, #{faceValue}, #{minSpend}, #{validDays},
            #{perUserLimit}, #{totalStock}, #{seckillTotalStock}, #{remainingStock},
            #{seckillRemainingStock}, #{status}, #{createTime}, #{updateTime}, #{version}
        )
    </insert>

    <insert id="batchInsertVirtualCoupons">
        INSERT INTO coupon (
            id, virtual_id, name, description, type, face_value, min_spend, valid_days,
            per_user_limit, total_stock, seckill_total_stock, remaining_stock,
            seckill_remaining_stock, status, create_time, update_time, version
        ) VALUES
        <foreach collection="list" item="coupon" separator=",">
            (
                #{coupon.id}, #{coupon.virtualId}, #{coupon.name}, #{coupon.description}, #{coupon.type},
                #{coupon.faceValue}, #{coupon.minSpend}, #{coupon.validDays}, #{coupon.perUserLimit},
                #{coupon.totalStock}, #{coupon.seckillTotalStock}, #{coupon.remainingStock},
                #{coupon.seckillRemainingStock}, #{coupon.status}, #{coupon.createTime}, #{coupon.updateTime},
                #{coupon.version}
            )
        </foreach>
    </insert>

    <!-- 按虚拟ID更新库存 -->
    <update id="updateStockByVirtualId">
        UPDATE coupon
        SET remaining_stock = remaining_stock + #{change},
            seckill_remaining_stock = seckill_remaining_stock + #{change},
            update_time = NOW(),
            version = version + 1
        WHERE virtual_id = #{virtualId}
          AND remaining_stock + #{change} >= 0
          AND seckill_remaining_stock + #{change} >= 0
          AND version = #{version}
    </update>

    <update id="updateRemainingStockByVirtualId">
        UPDATE coupon
        SET remaining_stock = #{remainingStock},
            update_time = #{updateTime},
            version = version + 1
        WHERE virtual_id = #{virtualId}
          AND version = #{version}
    </update>

    <!-- 查询指定优惠券的所有虚拟分片 -->
    <select id="selectByCouponId" resultMap="CouponResultMap">
        SELECT * FROM coupon WHERE virtual_id LIKE CONCAT(#{couponId}, '\_%')
    </select>

    <insert id="batchGrantCoupons">
        INSERT INTO user_coupon (user_id, coupon_id, create_time)
        VALUES
        <foreach collection="userIds" item="userId" separator=",">
            (#{userId}, #{couponId}, NOW())
        </foreach>
    </insert>

    <!-- 查询过期优惠券 -->
    <select id="selectExpiredCoupons" resultMap="CouponResultMap">
        SELECT * FROM coupon
        WHERE status = 1
        AND valid_days > 0
        AND create_time < #{expireTime}
    </select>

    <!-- 更新优惠券状态 -->
    <update id="updateCouponStatus">
        UPDATE coupon
        SET status = #{status}, update_time = NOW()
        WHERE id = #{couponId}
    </update>

    <!-- 按ID更新库存 -->
    <update id="updateStock">
        UPDATE coupon
        SET remaining_stock = remaining_stock + #{change},
            seckill_remaining_stock = seckill_remaining_stock + #{change},
            update_time = NOW(),
            version = version + 1
        WHERE id = #{couponId}
          AND remaining_stock + #{change} >= 0
          AND seckill_remaining_stock + #{change} >= 0
          AND version = #{version}
    </update>
</mapper>
