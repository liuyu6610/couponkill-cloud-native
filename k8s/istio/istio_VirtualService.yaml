# VirtualService配置，定义服务网格中的路由规则和服务访问策略
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: seckill-go-vs
  namespace: couponkill
spec:
  hosts:
    - "*"
  gateways:
    - istio-system/couponkill-gateway
  http:
    - match:
        - uri:
            prefix: /seckill
      route:
        - destination:
            host: seckill-go-svc.couponkill.svc.cluster.local
            port:
              number: 8090
      retries:
        attempts: 3
        perTryTimeout: 2s
        retryOn: gateway-error,connect-failure,refused-stream
      timeout: 5s
      fault:
        delay:
          percentage:
            value: 0.1
          fixedDelay: 5s
        abort:
          percentage:
            value: 0.1
          httpStatus: 400

---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: order-service-vs
  namespace: couponkill
spec:
  hosts:
    - "*"
  gateways:
    - istio-system/couponkill-gateway
  http:
    - match:
        - uri:
            prefix: /order
      route:
        - destination:
            host: couponkill-order-service.couponkill.svc.cluster.local
            port:
              number: 8082
      retries:
        attempts: 2
        perTryTimeout: 3s
        retryOn: gateway-error,connect-failure,refused-stream
      timeout: 10s

---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: coupon-service-vs
  namespace: couponkill
spec:
  hosts:
    - "*"
  gateways:
    - istio-system/couponkill-gateway
  http:
    - match:
        - uri:
            prefix: /api/v1/coupon
      route:
        - destination:
            host: couponkill-coupon-service.couponkill.svc.cluster.local
            port:
              number: 8081
      retries:
        attempts: 2
        perTryTimeout: 3s
        retryOn: gateway-error,connect-failure,refused-stream
      timeout: 15s

---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: user-service-vs
  namespace: couponkill
spec:
  hosts:
    - "*"
  gateways:
    - istio-system/couponkill-gateway
  http:
    - match:
        - uri:
            prefix: /api/v1/user
      route:
        - destination:
            host: couponkill-user-service.couponkill.svc.cluster.local
            port:
              number: 8083
      retries:
        attempts: 2
        perTryTimeout: 3s
        retryOn: gateway-error,connect-failure,refused-stream
      timeout: 15s

---
# 内部服务间通信的VirtualService配置
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: internal-services-vs
  namespace: couponkill
spec:
  hosts:
    - seckill-go-svc.couponkill.svc.cluster.local
    - couponkill-order-service.couponkill.svc.cluster.local
    - couponkill-coupon-service.couponkill.svc.cluster.local
    - couponkill-user-service.couponkill.svc.cluster.local
  http:
    # Go服务内部路由
    - match:
        - uri:
            prefix: /seckill
      route:
        - destination:
            host: seckill-go-svc.couponkill.svc.cluster.local
            port:
              number: 8090
      timeout: 5s

    # 订单服务内部路由
    - match:
        - uri:
            prefix: /order
      route:
        - destination:
            host: couponkill-order-service.couponkill.svc.cluster.local
            port:
              number: 8082
      timeout: 10s

    # 优惠券服务内部路由
    - match:
        - uri:
            prefix: /api/v1/coupon
      route:
        - destination:
            host: couponkill-coupon-service.couponkill.svc.cluster.local
            port:
              number: 8081
      timeout: 15s

    # 用户服务内部路由
    - match:
        - uri:
            prefix: /api/v1/user
      route:
        - destination:
            host: couponkill-user-service.couponkill.svc.cluster.local
            port:
              number: 8083
      timeout: 15s
